    boolean success(String message) {
        currentBuild.result = 'SUCCESS'
        echo message
        return false;
    }

    boolean shouldRun() {
        String message = sh(label: 'Get Commit Message', script: 'git log -1 --pretty=%B', returnStdout: true).trim()

        if (message.matches('.*\\[skip ci].*')) {
            return success('[skip] commit message contains [skip ci]')
        } else if (env.BRANCH_NAME != 'master' && message.matches("^\\[release] 'v.*")) {
            return success('[skip] only build releases on the master branch')
        } else {
            return true
        }
    }

    void toolSh(String command) {
        container('java-buildtools') {
            sh command
        }
    }

    pipeline {
        agent {
            kubernetes {
                yamlFile 'jenkins-agent.yml'
                podRetention never()
            }
        }
        parameters {

              string(name: 'TestProfile', defaultValue: 'PSanityCH', description: 'Test Profile Name')

            }

            triggers {
                parameterizedCron('''
                    # leave spaces where you want them around the parameters. They'll be trimmed.
                    # we let the build run with the default name
                    30 6 * * 1-5 %TestProfile=PSanitySS
                    00 7 * * 1-5 %TestProfile=PSanityCH
                ''')
            }

        environment {
            TEST_CRED = credentials('TEST_CRED')
            SAUCE_USERNAME = credentials('SAUCE_USERNAME')
            SAUCE_ACCESS_KEY=credentials('SAUCE_ACCESS_KEY')
            FTP_SERVER=credentials('FTP_SERVER')
            FTP_USERNAME=credentials('FTP_USERNAME')
            FTP_PASSWORD=credentials('FTP_PASSWORD')
        }
        stages {
            stage('Run CI?') {
                when { expression { shouldRun() } }
                stages {


                            stage('Environment Variables') {
                                steps { sh 'env | sort' }
                            }
                            stage('Credentials') {
                                environment {
                                    GITHUB_CREDENTIALS = credentials('github_daws_svc_account')
                                    ARTIFACTORY_CREDENTIALS = credentials('artifactory_serv_svc_dawsdev')
                                    SONARQUBE_TOKEN = credentials('sonarqube_serv_svc_dawsdev')
                                }
                                steps {

                                    toolSh 'github-credentials.sh'
                                    toolSh 'artifactory-credentials.sh'
                                    toolSh 'sonarqube-credentials.sh'
                                }
                            }


                             stage('Regression Tests') {
                                                 steps { toolSh "gradle sauceTest -${params.TestProfile} -i" }
                                                                 post {
                                                                     always {
                                                                        junit 'build/test-results/**/*.xml'
                                                                     }
                                                                 }
                                                             }


                }
            }
        }
    }
